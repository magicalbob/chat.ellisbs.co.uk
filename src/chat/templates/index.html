<!DOCTYPE html>
<html lang="en">
<head>
    <title>LLM Chat Index</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/static/script.js" defer></script>

    <style>
    .answer {
        color: blue;
    }

    .error {
        color: red;
    }

    #system-prompt-input {
        width: 100%;
        height: 200px; /* Larger to show default contract */
        resize: vertical;
    }

    #question-input {
        width: 100%;
        height: 100px;
        resize: vertical;
    }

    #chat-history {
        margin-top: 20px;
        border: 1px solid #ccc;
        padding: 10px;
        max-height: 400px;
        overflow-y: auto;
    }
    </style>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <script>
    // Convert Markdown to HTML using Showdown
    var converter = new showdown.Converter();

    // Function to update the chat history
    function updateChatHistory() {
        $.ajax({
            url: "/chat/chat_history",
            type: "get",
            success: function(response) {
                var chatHistoryElement = $("#chat-history");
                chatHistoryElement.html(response);
                chatHistoryElement.scrollTop(chatHistoryElement[0].scrollHeight);
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.log("Error: " + textStatus);
            }
        });
    }

    // Function to handle the "Ask" button click
    function askQuestion() {
        var questionInput = $("#question-input");
        var systemPromptInput = $("#system-prompt-input");
        var question = questionInput.val().trim();
        var systemPrompt = systemPromptInput.val().trim();
    
        if (question !== "") {
            questionInput.prop("disabled", true);
            systemPromptInput.prop("disabled", true);
            $("#ask-button").prop("disabled", true);
    
            $.ajax({
                url: "/chat/ask",
                type: "post",
                data: JSON.stringify({ 
                    question: question,
                    system_prompt: systemPrompt
                }),
                contentType: "application/json",
                success: function(response) {
                    questionInput.val("");
                    // Do NOT reset systemPromptInput — user controls it now
                    questionInput.prop("disabled", false);
                    systemPromptInput.prop("disabled", false);
                    $("#ask-button").prop("disabled", false);
                    updateChatHistory();
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.log("Error: " + textStatus);
                }
            });
        }
    }

    function initializeApp() {
        updateChatHistory();

        $("#ask-button").click(askQuestion);

        $("#question-input").keypress(function(event) {
            if (event.which === 13 && event.shiftKey) {
                return true; // newline
            } else if (event.which === 13) {
                askQuestion();
                return false; // prevent newline
            }
        });
    }

    $(document).ready(initializeApp);
    </script>
</head>
<body>
    <h1>{{ title }}</h1>

    <textarea id="system-prompt-input" placeholder="Enter system prompt..." rows="10">You are a helpful assistant. In all your responses, please focus on substance over praise. Skip unnecessary compliments, engage critically with my ideas, question my assumptions, identify my biases, and offer counterpoints when relevant. Don’t shy away from disagreement, and ensure that any agreements you have are grounded in reason and evidence.

Formatting rules:
- Write answers in GitHub-flavored Markdown (GFM).
- Use headings, short paragraphs, bullet lists, and code fences where helpful.
- Prefer Markdown tables over HTML tables.
- Do NOT mention that you are using Markdown or that you are following formatting rules.
- If the user asks for raw HTML, you may use HTML; otherwise stick to Markdown.
- When including code, use fenced blocks with an accurate language tag.
- Keep links as plain Markdown links; do not auto-embed scripts.

Response contract (important):
Return a JSON object with these keys:
- "format": one of ["markdown", "html", "text"]  (default: "markdown")
- "content": the answer body in that format
- "brief": a ≤100-character plain-text summary/title of the answer (optional)

Do not include any additional keys. Do not wrap the JSON in backticks.</textarea>

    <textarea id="question-input" placeholder="Ask a question..." rows="4"></textarea>
    <button id="ask-button">Ask</button>

    <div id="chat-history"></div>
</body>
</html>
